name: canbench-regression

on:
  pull_request:
    paths:
      - "Cargo.toml"
      - "Cargo.lock"
      - "canbench.yml"
      - "canbench_results.yml"
      - "src/**"
      - "ci/check_canbench_regression.py"
      - ".github/workflows/canbench-regression.yml"
  push:
    branches:
      - main

jobs:
  canbench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install cargo-canbench
        run: cargo install cargo-canbench --locked

      - name: Run canbench and compare with baseline
        run: |
          cp canbench_results.yml /tmp/canbench_results.baseline.yml
          cargo canbench
          python3 ci/check_canbench_regression.py \
            /tmp/canbench_results.baseline.yml \
            canbench_results.yml \
            15
